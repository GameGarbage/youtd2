[gd_scene load_steps=15 format=3 uid="uid://bqla7lwvfi4yo"]

[ext_resource type="StyleBox" uid="uid://d1lgejw2sv1ip" path="res://Resources/Theme/Common/tiny_border_box.tres" id="1_1n3o6"]
[ext_resource type="Texture2D" uid="uid://ddjiu85tn8wbv" path="res://Resources/Textures/UI/Icons/ice.tres" id="3_6qw8f"]
[ext_resource type="Texture2D" uid="uid://cmnfe6fi0wgsb" path="res://Resources/Textures/UI/Icons/darkness.tres" id="4_bwsck"]
[ext_resource type="Texture2D" uid="uid://dlmpx46h3jvmj" path="res://Resources/Textures/UI/Icons/storm.tres" id="5_8ws5j"]
[ext_resource type="Texture2D" uid="uid://ty26wea46uux" path="res://Resources/Textures/UI/Icons/iron.tres" id="6_1rc5q"]
[ext_resource type="Texture2D" uid="uid://bw81x17f8trjj" path="res://Resources/Textures/UI/Icons/astral.tres" id="7_bthr6"]
[ext_resource type="Texture2D" uid="uid://dt7vupry6p4y1" path="res://Resources/Textures/UI/Icons/fire.tres" id="8_fyf0i"]
[ext_resource type="Texture2D" uid="uid://om2iw3jtshn6" path="res://Resources/Textures/UI/Icons/nature.tres" id="9_5y0bo"]

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_ayjvs"]

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_ay2xb"]

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_ddnvf"]

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_cnx2k"]

[sub_resource type="Theme" id="Theme_wei57"]
Button/colors/font_color = Color(0.87451, 0.87451, 0.87451, 0.745098)
Button/colors/icon_normal_color = Color(1, 1, 1, 0.733333)
Button/font_sizes/font_size = 16
Button/styles/disabled = SubResource("StyleBoxEmpty_ayjvs")
Button/styles/hover = SubResource("StyleBoxEmpty_ay2xb")
Button/styles/normal = SubResource("StyleBoxEmpty_ddnvf")
Button/styles/pressed = SubResource("StyleBoxEmpty_cnx2k")
Label/font_sizes/font_size = 16
PanelContainer/styles/panel = ExtResource("1_1n3o6")
RichTextLabel/font_sizes/normal_font_size = 12

[sub_resource type="GDScript" id="GDScript_tiheu"]
script/source = "extends Control

@onready var _element_to_button_map: Dictionary = {
	Element.enm.ICE: { \"button\": ice_button, \"label\": ice_button_label },
	Element.enm.NATURE: { \"button\": nature_button, \"label\": nature_button_label },
	Element.enm.FIRE: { \"button\": fire_button, \"label\": fire_button_label },
	Element.enm.ASTRAL: { \"button\": astral_button, \"label\": astral_button_label },
	Element.enm.DARKNESS: { \"button\": darkness_button, \"label\": darkness_button_label },
	Element.enm.IRON: { \"button\": iron_button, \"label\": iron_button_label },
	Element.enm.STORM: { \"button\": storm_button, \"label\": storm_button_label },
}

@export var ice_button_label: RichTextLabel
@export var fire_button_label: RichTextLabel
@export var iron_button_label: RichTextLabel
@export var darkness_button_label: RichTextLabel
@export var storm_button_label: RichTextLabel
@export var astral_button_label: RichTextLabel
@export var nature_button_label: RichTextLabel

@export var ice_button: Button
@export var fire_button: Button
@export var iron_button: Button
@export var darkness_button: Button
@export var storm_button: Button
@export var astral_button: Button
@export var nature_button: Button

var _hovered_button_element: Element.enm = Element.enm.NONE


func _ready():
	for element in _element_to_button_map.keys():
		var button: Button = _element_to_button_map[element][\"button\"]

		button.pressed.connect(_on_button_pressed.bind(element))
		button.mouse_entered.connect(_on_button_mouse_entered.bind(element))
		button.mouse_exited.connect(_on_button_mouse_exited)
		
		refresh_button_label(element, false)

	KnowledgeTomesManager.knowledge_tomes_change.connect(_on_knowledge_tomes_change)

	_on_knowledge_tomes_change()


func _on_button_pressed(element: Element.enm):
	ElementLevel.increment(element)

	var cost: int = ElementLevel.get_research_cost(element)
	KnowledgeTomesManager.spend(cost)

	refresh_button_label(element, _hovered_button_element == element)
	refresh_button_tooltip()


func _on_button_mouse_entered(element: Element.enm):
	EventBus.research_button_mouse_entered.emit(element)
	refresh_button_label(element, true)
	_hovered_button_element = element


func _on_button_mouse_exited():
	EventBus.research_button_mouse_exited.emit()
	refresh_button_label(_hovered_button_element, false)
	_hovered_button_element = Element.enm.NONE


func _on_knowledge_tomes_change():
	for element in _element_to_button_map.keys():
		var button: Button = _element_to_button_map[element][\"button\"]
		var can_afford: bool = ElementLevel.can_afford_research(element)

		button.set_disabled(!can_afford)

	refresh_button_tooltip()


func refresh_button_tooltip():
	if _hovered_button_element != Element.enm.NONE:
		_on_button_mouse_entered(_hovered_button_element)


func refresh_button_label(element: Element.enm, hovered: bool):
	var label: RichTextLabel = _element_to_button_map[element][\"label\"]
	label.clear()
	label.append_text(RichTexts.get_research_button_label(element, hovered))
"

[node name="ResearchMenu" type="Control" node_paths=PackedStringArray("ice_button_label", "fire_button_label", "iron_button_label", "darkness_button_label", "storm_button_label", "astral_button_label", "nature_button_label", "ice_button", "fire_button", "iron_button", "darkness_button", "storm_button", "astral_button", "nature_button")]
layout_mode = 3
anchors_preset = 0
theme = SubResource("Theme_wei57")
script = SubResource("GDScript_tiheu")
ice_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer/NewLevelLabel")
fire_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer6/NewLevelLabel")
iron_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer4/NewLevelLabel")
darkness_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer2/NewLevelLabel")
storm_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer3/NewLevelLabel")
astral_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer5/NewLevelLabel")
nature_button_label = NodePath("PanelContainer/VBoxContainer/HBoxContainer7/NewLevelLabel")
ice_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer/IceButton")
fire_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer6/FireButton")
iron_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer4/IronButton")
darkness_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer2/DarknessButton")
storm_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer3/StormButton")
astral_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer5/AstralButton")
nature_button = NodePath("PanelContainer/VBoxContainer/HBoxContainer7/NatureButton")

[node name="PanelContainer" type="PanelContainer" parent="."]
layout_mode = 0
offset_right = 40.0
offset_bottom = 40.0

[node name="VBoxContainer" type="VBoxContainer" parent="PanelContainer"]
custom_minimum_size = Vector2(150, 0)
layout_mode = 2

[node name="Label" type="Label" parent="PanelContainer/VBoxContainer"]
layout_mode = 2
text = "Research"
horizontal_alignment = 1

[node name="HBoxContainer" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="IceButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Ice"
icon = ExtResource("3_6qw8f")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19 ➜ 20"
fit_content = true
scroll_active = false

[node name="HBoxContainer2" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="DarknessButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer2"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Darkness"
icon = ExtResource("4_bwsck")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer2"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19 ➜ 20"
fit_content = true
scroll_active = false

[node name="HBoxContainer3" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="StormButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer3"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Storm"
icon = ExtResource("5_8ws5j")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer3"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19"
fit_content = true
scroll_active = false

[node name="HBoxContainer4" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="IronButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer4"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Iron"
icon = ExtResource("6_1rc5q")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer4"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19"
fit_content = true
scroll_active = false

[node name="HBoxContainer5" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="AstralButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer5"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Astral"
icon = ExtResource("7_bthr6")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer5"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19"
fit_content = true
scroll_active = false

[node name="HBoxContainer6" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="FireButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer6"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Fire"
icon = ExtResource("8_fyf0i")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer6"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19"
fit_content = true
scroll_active = false

[node name="HBoxContainer7" type="HBoxContainer" parent="PanelContainer/VBoxContainer"]
layout_mode = 2

[node name="NatureButton" type="Button" parent="PanelContainer/VBoxContainer/HBoxContainer7"]
custom_minimum_size = Vector2(0, 20)
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 2.0
text = "Nature"
icon = ExtResource("9_5y0bo")
alignment = 0
expand_icon = true

[node name="NewLevelLabel" type="RichTextLabel" parent="PanelContainer/VBoxContainer/HBoxContainer7"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 4
text = "19"
fit_content = true
scroll_active = false
